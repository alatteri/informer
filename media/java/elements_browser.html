<HTML>
<HEAD>
<TITLE>Choose an Element</TITLE>

<link rel="stylesheet" type="text/css" media="screen" href="/media/stylesheets/screen.css" />

<script type="text/javascript" src="/media/js/prototype.js"></script>
<script type="text/javascript" src="/media/js/informer.js"></script>
<script type="text/javascript" src="/media/js/global.js"></script>

<script language='javascript'>
function basename(path) {
    return '/' == path ? path : path.substring(path.lastIndexOf('/') + 1);
}

function dirname(path) {
    var dir = path.substring(0, path.lastIndexOf('/'));
    if (dir == '') dir = '/';
    return dir;
}

function getFiles(path) {
    return getObjects(path, 'file', document.directoryService.getFiles(path));
}

function getDirs(path) {
    return getObjects(path, 'dir', document.directoryService.getDirectories(path));
}

function getObjects(path, type, result) {
    var objects = [];
    if (result != null) {
        result = "" + result;   // make sure it's a string
        result = result.split('/');
        for (var i=0; i < result.length; i++) {
            var name = result[i];
            var full = (path == '/' ? '' : path) + '/' + name;
            objects.push({ type: type, path: full, name: name });
        }
    }
    return objects;
}

function getDirEntries(path) {
    var entries = [];
    entries = entries.concat(getFiles(path));
    entries = entries.concat(getDirs(path));
    return entries;
}

function DisplayDropDown(path) {
    // clear the dropdown
    var dropdown = $('elements_browser-controls-directory');
    while (dropdown.hasChildNodes())
       dropdown.removeChild(dropdown.firstChild);

    // add the path's components to the drop down
    var component = path;
    do {
        var dir = basename(component);
        var option = document.createElement('OPTION');
        option.appendChild(document.createTextNode(dir));
        option.value = component;
        dropdown.appendChild(option);
        component = dirname(component);
    } while (dir != '/');
    dropdown.selectedIndex = 0;
}

function DisplayEntries(entries) {
    // clear the display
    var elements = $('elements');
    while (elements.hasChildNodes())
       elements.removeChild(elements.firstChild);

    // display the new entries
    for (var i=0; i < entries.length; i++) {
        var a = document.createElement('A');
        var content = document.createTextNode(entries[i].name);
        a.appendChild(content);

        var li = document.createElement('LI');
        li.appendChild(a);

        if ('file' == entries[i].type) {
            li.className = 'element';
            a.href = "javascript:select('" + entries[i].path + "')";
        } else {
            li.className = 'folder';
            a.href = "javascript:browse('" + entries[i].path + "')";
        }
        elements.appendChild(li);
    }
}

function browse(path) {
    // Display the dropdown UI
    DisplayDropDown(path);

    // get the direntries and sort by name
    var entries = getDirEntries(path);
    entries = entries.sortBy(function (x) {
        return x.name.toLowerCase();
    });

    // Display the directory entries
    DisplayEntries(entries);
    styleSelects();
}

function select(path) {
    // TODO: window.opener callback
    window.opener.ElementBrowserSelection(path);
    window.close();
}

function cancel() {
    window.close();
}
</script>
</HEAD>

<body id="browser">
<APPLET archive="directoryService_signed.jar" code="directoryService" name="directoryService" width=0 height=0>
Your browser does not support Java, you will not be able to browse for elements.
</APPLET>

<div id="elements_browser">
    <h3>Select an element or sequence of elements below.</h3>
    <form id="form-element-browser" action="#" method="post">
        <select id="elements_browser-controls-directory" onchange="browse(this.options[this.selectedIndex].value)">
        </select>
        <ul id="elements">
        </ul>
        <button type="submit">Choose</button>
        <a href="javascript:cancel()" title="Cancel" class="cancel">Cancel</a>
        <div class="clear"></div>
    </form>
</div>

<script>
browse('/');
styleSelects();
</script>
</BODY>
</HTML>
