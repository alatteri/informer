{% extends "informer/shot_detail_base.html" %}

{% block body_id %}notes{% endblock %}

{% block content %}
        <div class="left">
          <div class="box medium">
            <h3>Add a note</h3>
            <form id="form-note-create" action="#" method="post">
              <input type="hidden" name="is_checked" value="false" />
              <textarea name="text" id="form-note-create-message"></textarea>
              <p>
                <strong>Assign this task to:</strong>
                <select name="assigned_to" id="form-note-create-assign"><option value="">Anyone</option>
                {% for user in users %}
                <option value="{{user.username}}">{{ user.username }}</option>
                {% endfor %}
                </select>
                <input type="image" id="form-note-create-submit" src="/site_media/images/button-addNote.gif" onclick="add_note();return false;"/>
              </p>
            </form>
            <div class="bottom">&nbsp;</div>
          </div>
          <div class="box medium">
            <h3>All Notes</h3>
            <ul class="heading" id="notes_heading">
              <li class="date false highlight" onclick="Notes.resort_table('date'); highlightHeading(this, Notes);">Date</li>
              <li class="author false" onclick="Notes.resort_table('author'); highlightHeading(this, Notes);">Author</li>
              <li class="assignedTo false" onclick="Notes.resort_table('assignedTo'); highlightHeading(this, Notes);">Assigned To</li>
              <li class="status false" onclick="Notes.resort_table('status'); highlightHeading(this, Notes);">Status</li>
            </ul>
            <ul class="entries" id="notes_entries">
            </ul>
            <div class="bottom">&nbsp;</div>
          </div>
        </div>
        <div class="right">
          <div class="box small">
            <h3>Status</h3>
            <ul id='filter_status'>
                <li>foo bar</li>
            </ul>
          </div>
          <div class="box small">
            <h3>Author</h3>
            <ul id='filter_author'>
            </ul>
          </div>
          <div class="box small">
            <h3>Assigned to</h3>
            <ul id='filter_assigned_to'>
            </ul>
          </div>
        </div>
        <div class="clear">&nbsp;</div>
      </div>
{% endblock %}

{% block script %}

/* Notes functions
 * ------------------------------------------------------ */

// Generates status row with click event
function create_status_item(info, item) {
    var value = get_value(info, item);
    var status_li = document.createElement('li');
    status_li.className = info.name;
    var status_a = document.createElement('a');
    Element.extend(status_a);
    status_a.appendChild(document.createTextNode(value));
    status_li.appendChild(status_a);
    status_a.observe(
      'click',
      function() {new Ajax.Request(
        Notes.url, {
        parameters: {id: 'test'},
	onComplete: function() {
	alert('success');}}) });

    return status_li; };

/* called when page first loaded, initialize data */
function setup() {
  Notes = new Informer.Data(
    'notes', // name
    [ // row_1
      {name: 'date',
       field: 'fields.created_on',
       sorter: sort_by_date,
       formatter: format_date,
       parser: parse_date,
       is_default: true},
      {name: 'author',
       field:'fields.created_by',
       sorter: sort_by_string,
       formatter: format_author},
       {name: 'assignedTo',
        field:'fields.assigned_to',
        sorter: sort_by_assigned,
        formatter: format_assigned},
       {name: 'status',
        field: 'fields.is_checked',
        sorter: sort_by_string,
        parser: parse_boolean,
        formatter: format_pending,
	}
    ],
    { //row_2
     field: 'fields.text',
     formatter: format_nl2br
    },
    [ // filter_list
      new Informer.Filter('filter_status',      'fields.is_checked',  format_pending),
      new Informer.Filter('filter_author',      'fields.created_by',  format_author),
      new Informer.Filter('filter_assigned_to', 'fields.assigned_to', format_assigned),
    ]);

    Notes.url = '{{shot.get_json_notes_url}}';
	Notes.load_data({{ data }});
    Notes._sorter = "date";
    Notes.resort_table();
	highlightColumn('date');
}

/* called when user clicks on the 'Add Note' button */
function add_note() {
    // make sure the user entered something
    if (!$F('form-note-create-message')) {
        alert('Please enter a note first');
        return;
    }

    // fire off the request to the server to create the note
    new Ajax.Request(Notes.url, {
        parameters: $('form-note-create').serialize(),
        evalJSON:   true,
        onSuccess:  add_note_callback,
    });
}

/* Ajax callback triggered after a user clicks the 'Add Note' button */
function add_note_callback(r) {
    $('form-note-create').reset();	
	styleSelects();
    Notes.add_data(r.responseJSON[0]);
    Notes.resort_table();
}

  

// onload trigger
Event.observe(window, 'load', setup);
{% endblock %}
